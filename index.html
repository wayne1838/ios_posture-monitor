<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro AI 姿勢監測儀</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>
    
    <style>
        :root { --primary: #007AFF; --danger: #FF3B30; --success: #34C759; }
        body { font-family: -apple-system, system-ui, sans-serif; background: #1c1c1e; color: white; margin: 0; display: flex; flex-direction: column; align-items: center; }
        
        #video-container { position: relative; width: 95vw; max-width: 500px; aspect-ratio: 3/4; background: #000; border-radius: 20px; overflow: hidden; margin-top: 15px; border: 2px solid #333; }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: scaleX(-1); }

        .status-bar { width: 95vw; max-width: 500px; padding: 15px; border-radius: 15px; margin-top: 15px; text-align: center; font-weight: bold; font-size: 1.1rem; transition: 0.3s; background: #2c2c2e; }
        .is-bad { background: var(--danger); animation: shake 0.5s infinite; }
        
        .settings-panel { width: 95vw; max-width: 500px; background: #2c2c2e; border-radius: 15px; padding: 15px; margin-top: 15px; box-sizing: border-box; }
        .setting-item { margin-bottom: 15px; }
        .setting-item label { display: block; font-size: 0.9rem; color: #aeaeb2; margin-bottom: 5px; }
        input[type=range] { width: 100%; margin: 10px 0; }
        
        .btn-group { display: flex; gap: 10px; margin-top: 15px; }
        button { flex: 1; padding: 12px; border-radius: 12px; border: none; font-weight: 600; font-size: 1rem; cursor: pointer; }
        #startBtn { background: var(--primary); color: white; }
        #caliBtn { background: var(--success); color: white; display: none; }

        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(5px); } 50% { transform: translateX(-5px); } 75% { transform: translateX(5px); } 100% { transform: translateX(0); } }
    </style>
</head>
<body>

    <div id="video-container">
        <video id="video" playsinline></video>
        <canvas id="canvas"></canvas>
    </div>

    <div id="status" class="status-bar">模型載入中...</div>

    <div class="settings-panel">
        <div class="setting-item">
            <label>頸部前傾閾值 (角度): <span id="angleVal">25</span>°</label>
            <input type="range" id="angleThreshold" min="10" max="60" value="25">
        </div>
        <div class="setting-item">
            <label>脊椎塌陷感應度: <span id="slumpVal">0.4</span></label>
            <input type="range" id="slumpThreshold" min="0.1" max="0.8" step="0.05" value="0.4">
        </div>
        <div class="setting-item">
            <label>判定延遲 (格數): <span id="frameVal">10</span></label>
            <input type="range" id="frameDelay" min="1" max="30" value="10">
        </div>
        
        <div class="btn-group">
            <button id="startBtn">啟動 AI 監測</button>
            <button id="caliBtn">校準良好姿勢</button>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const statusDiv = document.getElementById('status');
        
        let detector;
        let config = {
            angleLimit: 25,
            slumpLimit: 0.4,
            delay: 10
        };
        
        let baseline = { neckAngle: null, slumpRatio: null };
        let badFrameCount = 0;

        // 滑桿事件監聽
        document.getElementById('angleThreshold').oninput = function() { config.angleLimit = this.value; document.getElementById('angleVal').innerText = this.value; };
        document.getElementById('slumpThreshold').oninput = function() { config.slumpLimit = this.value; document.getElementById('slumpVal').innerText = this.value; };
        document.getElementById('frameDelay').oninput = function() { config.delay = this.value; document.getElementById('frameVal').innerText = this.value; };

        async function init() {
            detector = await poseDetection.createDetector(
                poseDetection.SupportedModels.MoveNet,
                { modelType: poseDetection.movenet.modelType.SINGLEPOSE_LIGHTNING }
            );
            statusDiv.innerText = "準備就緒，請啟動鏡頭";
        }

        document.getElementById('startBtn').onclick = async () => {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
            video.srcObject = stream;
            await video.play();
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('caliBtn').style.display = 'block';
            statusDiv.innerText = "請坐正後點擊『校準』";
            if (Notification.permission !== "granted") Notification.requestPermission();
            detect();
        };

        document.getElementById('caliBtn').onclick = () => {
            // 校準將在下一幀自動執行一捕捉
            baseline.neckAngle = -1; // 標記為待捕捉
            statusDiv.innerText = "正在自動校準基準值...";
        };

        async function detect() {
            const poses = await detector.estimatePoses(video);
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (poses.length > 0) {
                const kp = poses[0].keypoints.reduce((acc, k) => ({ ...acc, [k.name]: k }), {});
                
                // 核心關鍵點：耳朵與肩膀
                const ear = kp.left_ear.score > 0.5 ? kp.left_ear : kp.right_ear;
                const shoulder = kp.left_shoulder.score > 0.5 ? kp.left_shoulder : kp.right_shoulder;
                const shoulderWidth = Math.abs(kp.left_shoulder.x - kp.right_shoulder.x);

                if (ear.score > 0.5 && shoulder.score > 0.5) {
                    // 1. 計算頸部角度 (與垂直線夾角)
                    const dx = Math.abs(ear.x - shoulder.x);
                    const dy = Math.abs(ear.y - shoulder.y);
                    const neckAngle = Math.atan2(dx, dy) * (180 / Math.PI);

                    // 2. 計算脊椎比例 (耳朵到肩膀距離 / 肩膀寬度) -> 標準化
                    const slumpRatio = dy / shoulderWidth;

                    // 繪製骨架視覺化
                    drawSkeleton(ctx, ear, shoulder);

                    // 校準邏輯
                    if (baseline.neckAngle === -1) {
                        baseline.neckAngle = neckAngle;
                        baseline.slumpRatio = slumpRatio;
                        statusDiv.innerText = "校準完成！監控中...";
                    }

                    // 判斷邏輯
                    const isLeaningForward = neckAngle > config.angleLimit;
                    const isSlumping = baseline.slumpRatio ? (slumpRatio < baseline.slumpRatio * (1 - config.slumpLimit)) : false;

                    if (isLeaningForward || isSlumping) {
                        badFrameCount++;
                        if (badFrameCount > config.delay) {
                            updateUI(true, isLeaningForward ? "⚠️ 偵測到烏龜頸" : "⚠️ 偵測到脊椎塌陷");
                        }
                    } else {
                        badFrameCount = 0;
                        updateUI(false, "✅ 姿勢良好");
                    }
                }
            }
            requestAnimationFrame(detect);
        }

        function drawSkeleton(ctx, ear, shoulder) {
            ctx.beginPath();
            ctx.moveTo(ear.x, ear.y);
            ctx.lineTo(shoulder.x, shoulder.y);
            ctx.strokeStyle = "white";
            ctx.lineWidth = 4;
            ctx.stroke();
            ctx.fillStyle = "cyan";
            ctx.fill();
        }

        function updateUI(isBad, msg) {
            statusDiv.innerText = msg;
            if (isBad) {
                statusDiv.classList.add('is-bad');
                if (badFrameCount === config.delay + 1) { // 剛觸發時通知
                    if (Notification.permission === "granted") new Notification("姿勢提醒", { body: msg });
                    if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                }
            } else {
                statusDiv.classList.remove('is-bad');
            }
        }

        init();
    </script>
</body>
</html>
